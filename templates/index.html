<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ứng dụng Hello World</title>
  <style>
    :root{--bg1:#e3f2fd;--bg2:#bbdefb;--accent:#0078D4;--ok:#4CAF50;--danger:#f44336}
    html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2))}
    .toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;background:rgba(255,255,255,0.95);padding:10px 18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);align-items:center;z-index:1000}
    .toolbar input{padding:8px 10px;border-radius:8px;border:1px solid #90caf9;min-width:220px}
    .toolbar button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700;color:#fff}
    #btnAdd{background:var(--accent)}#btnShow{background:var(--ok)}#btnClear{background:var(--danger)}
    .hello{position:fixed;max-width:320px;padding:8px 12px;border-radius:10px;border:2px solid #1976d2;background:rgba(255,255,255,0.9);color:#1976d2;font-weight:700;animation:pop .28s;z-index:900}
    @keyframes pop{from{transform:scale(.7);opacity:0}to{transform:scale(1);opacity:1}}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap;border:0}
    .toast{position:fixed;right:14px;bottom:14px;background:#222;color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.2);z-index:1200;transition:opacity 0.3s}
    @media (max-width:480px){.toolbar{left:8px;transform:none;right:8px;flex-wrap:wrap}.toolbar input{flex:1;min-width:120px}}
  </style>
</head>
<body>
  <div class="toolbar" role="region" aria-label="Controls">
    <label for="messageInput" class="sr-only">Nội dung</label>
    <input id="messageInput" type="text" placeholder="Nhập gì đó..." maxlength="500" autocomplete="off" aria-describedby="status" />
    <button id="btnAdd" type="button">Thêm</button>
    <button id="btnShow" type="button">Hiển thị ngẫu nhiên</button>
    <button id="btnClear" type="button">Xóa tất cả</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" style="display:none"></div>

  <script>
    const input = document.getElementById('messageInput');
    const btnAdd = document.getElementById('btnAdd');
    const btnShow = document.getElementById('btnShow');
    const btnClear = document.getElementById('btnClear');
    const toast = document.getElementById('toast');

    function showToast(text, timeout = 2500) {
      toast.textContent = text;
      toast.style.display = 'block';
      toast.style.opacity = '1';
      clearTimeout(toast._t);
      toast._t = setTimeout(()=> { toast.style.opacity = '0'; toast._t2 = setTimeout(()=>toast.style.display='none',300); }, timeout);
    }

    async function safeFetch(path, opts = {}) {
      const res = await fetch(path, opts);
      const contentType = res.headers.get('content-type') || '';
      let body = contentType.includes('application/json') ? await res.json() : await res.text();
      if (!res.ok) throw new Error((body && body.error) || (typeof body === 'string' && body) || res.statusText);
      return body;
    }

    btnAdd.addEventListener('click', async () => {
      const msg = input.value.trim();
      if (!msg) { showToast('Vui lòng nhập nội dung'); input.focus(); return; }
      btnAdd.disabled = true;
      try {
        await safeFetch('/api/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });
        input.value = '';
        showToast('Đã thêm');
      } catch (e) {
        console.error('Add error', e);
        showToast('Lỗi khi thêm: ' + (e.message || 'Unknown'));
      } finally { btnAdd.disabled = false; }
    });

    btnShow.addEventListener('click', async () => {
      btnShow.disabled = true;
      try {
        const data = await safeFetch('/api/random');
        const message = data && data.message ? data.message : null;
        if (!message) { showToast('Chưa có dữ liệu'); return; }

        const el = document.createElement('div');
        el.className = 'hello';
        el.textContent = message;
        document.body.appendChild(el);
        el.style.left = Math.random() * (window.innerWidth - el.offsetWidth) + 'px';
        el.style.top = Math.random() * (window.innerHeight - el.offsetHeight) + 'px';
        el.tabIndex = 0;
        el.title = 'Nhấn để đóng';
        el.addEventListener('click', () => el.remove());
        el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') el.remove(); });
      } catch (e) {
        console.error('Show error', e);
        showToast('Không thể lấy dữ liệu');
      } finally { btnShow.disabled = false; }
    });

    btnClear.addEventListener('click', async () => {
      if (!confirm('Xóa tất cả?')) return;
      btnClear.disabled = true;
      try {
        await safeFetch('/api/clear', { method: 'DELETE' });
        document.querySelectorAll('.hello').forEach(n => n.remove());
        showToast('Đã xóa');
      } catch (e) {
        console.error('Clear error', e);
        showToast('Lỗi khi xóa');
      } finally { btnClear.disabled = false; }
    });

    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnAdd.click();
      }
    });
  </script>
</body>
</html>
